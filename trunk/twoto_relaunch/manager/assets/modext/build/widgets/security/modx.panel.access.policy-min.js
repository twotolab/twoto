MODx.panel.AccessPolicy=function(A){A=A||{};Ext.applyIf(A,{url:MODx.config.connectors_url+"security/access/policy.php",baseParams:{action:"update",id:MODx.request.id},id:"modx-panel-access-policy",class_key:"modAccessPolicy",plugin:"",bodyStyle:"",defaults:{collapsible:false,autoHeight:true},items:[{html:"<h2>"+_("chunk_new")+"</h2>",border:false,cls:"modx-page-header",id:"modx-policy-header"},{xtype:"modx-tabs",defaults:{bodyStyle:"padding: 15px",autoHeight:true,border:true},forceLayout:true,deferredRender:false,items:[{title:_("policy"),layout:"form",items:[{html:"<p>"+_("policy_desc")+"</p>",border:false},{xtype:"hidden",name:"id",value:A.plugin},{xtype:"textfield",fieldLabel:_("name"),name:"name",width:300,maxLength:255,enableKeyEvents:true,allowBlank:false,listeners:{"keyup":{scope:this,fn:function(B,C){Ext.getCmp("modx-policy-header").getEl().update("<h2>"+_("policy")+": "+B.getValue()+"</h2>");}}}},{xtype:"textarea",fieldLabel:_("description"),name:"description",width:300,grow:true},{xtype:"textfield",fieldLabel:_("lexicon"),name:"lexicon",width:300,allowBlank:true,value:"permissions"}]},{title:_("permissions"),layout:"form",items:[{html:"<p>"+_("permissions_desc")+"</p>",border:false},{xtype:"modx-grid-permissions",policy:MODx.request.id,autoHeight:true,preventRender:true}]}]}],useLoadingMask:true,listeners:{"setup":{fn:this.setup,scope:this},"success":{fn:this.success,scope:this},"beforeSubmit":{fn:this.beforeSubmit,scope:this}}});MODx.panel.AccessPolicy.superclass.constructor.call(this,A);};Ext.extend(MODx.panel.AccessPolicy,MODx.FormPanel,{setup:function(){if(this.config.policy===""||this.config.policy===0){this.fireEvent("ready");return false;}MODx.Ajax.request({url:this.config.url,params:{action:"get",id:this.config.policy},listeners:{"success":{fn:function(B){this.getForm().setValues(B.object);var A=Ext.getCmp("modx-grid-permissions");if(A){A.getStore().loadData(B.object.permissions);}Ext.getCmp("modx-policy-header").getEl().update("<h2>"+_("policy")+": "+B.object.name+"</h2>");this.fireEvent("ready");MODx.fireEvent("ready");},scope:this}}});},beforeSubmit:function(B){var A=Ext.getCmp("modx-grid-permissions");Ext.apply(B.form.baseParams,{permissions:A?A.encode():{}});},success:function(A){Ext.getCmp("modx-grid-permissions").getStore().commitChanges();}});Ext.reg("modx-panel-access-policy",MODx.panel.AccessPolicy);MODx.grid.Permissions=function(A){A=A||{};Ext.applyIf(A,{id:"modx-grid-permissions",url:MODx.config.connectors_url+"security/access/policy/index.php",baseParams:{action:"getAttributes"},fields:["name","description","description_trans","value","menu"],columns:[{header:_("name"),dataIndex:"name",width:150,editor:{xtype:"textfield",renderer:true}},{header:_("description"),dataIndex:"description_trans",width:250,editable:false}],data:[],width:"90%",height:300,maxHeight:300,autosave:false,autoExpandColumn:"name",tbar:[{text:_("permission_new"),scope:this,handler:this.createAttribute}]});MODx.grid.Permissions.superclass.constructor.call(this,A);this.propRecord=new Ext.data.Record.create(["name","description","value"]);};Ext.extend(MODx.grid.Permissions,MODx.grid.LocalGrid,{createAttribute:function(A,B){this.loadWindow(A,B,{xtype:"modx-window-permission-create",record:{},blankValues:true,listeners:{"success":{fn:function(D){var C=this.getStore();var E=new this.propRecord(D);C.add(E);Ext.getCmp("modx-panel-access-policy").fireEvent("fieldChange");},scope:this}}});return true;},remove:function(){var A=this.getSelectionModel().getSelected();if(this.fireEvent("beforeRemoveRow",A)){this.getStore().remove(A);this.fireEvent("afterRemoveRow",A);}},_showMenu:function(C,B,D){D.stopEvent();D.preventDefault();var A=this.menu;A.recordIndex=B;A.record=this.getStore().getAt(B).data;if(!this.getSelectionModel().isSelected(B)){this.getSelectionModel().selectRow(B);}A.removeAll();A.add({text:_("permission_remove"),scope:this,handler:this.remove});A.show(D.target);}});Ext.reg("modx-grid-permissions",MODx.grid.Permissions);MODx.window.NewPermission=function(A){A=A||{};this.ident=A.ident||"polpc"+Ext.id();Ext.applyIf(A,{title:_("permission_new"),height:150,width:475,url:MODx.config.connectors_url+"security/access/policy/index.php",action:"addProperty",saveBtnText:_("add"),fields:[{xtype:"modx-combo-permission",fieldLabel:_("name"),name:"name",hiddenName:"name",id:"modx-"+this.ident+"-name",anchor:"90%"},{xtype:"textarea",fieldLabel:_("description"),name:"description",id:"modx-"+this.ident+"-description",anchor:"90%",grow:true}]});MODx.window.NewPermission.superclass.constructor.call(this,A);};Ext.extend(MODx.window.NewPermission,MODx.Window,{submit:function(){var E=this.fp.getForm().getValues();var D=Ext.getCmp("modx-grid-permissions");var C=D.getStore();var B=C.findExact("name",E.name);if(B!=-1){MODx.msg.alert(_("error"),_("permission_err_ae"));return false;}var A=Ext.getCmp("modx-"+this.ident+"-name");C=A.getStore();var F=C.getAt(C.find("name",E.name));if(F){E.description=F.data.description;E.description_trans=F.data.description;}E.value=1;this.fireEvent("success",E);this.hide();return false;}});Ext.reg("modx-window-permission-create",MODx.window.NewPermission);MODx.combo.Permission=function(A){A=A||{};Ext.applyIf(A,{name:"permission",hiddenName:"permission",displayField:"name",valueField:"name",fields:["name","description"],editable:true,typeAhead:false,forceSelection:false,tpl:new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><span style="font-weight: bold">{name}</span>','<p style="margin: 0; font-size: 11px; color: gray;">{description}</p></div></tpl>'),url:MODx.config.connectors_url+"security/access/permission.php"});MODx.combo.Permission.superclass.constructor.call(this,A);};Ext.extend(MODx.combo.Permission,MODx.combo.ComboBox);Ext.reg("modx-combo-permission",MODx.combo.Permission);